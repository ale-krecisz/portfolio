{"ast":null,"code":"'use strict';\n\nexports.__esModule = true;\n\nvar _core = require('../core');\n\nvar core = _interopRequireWildcard(_core);\n\nvar _ismobilejs = require('ismobilejs');\n\nvar _ismobilejs2 = _interopRequireDefault(_ismobilejs);\n\nvar _accessibleTarget = require('./accessibleTarget');\n\nvar _accessibleTarget2 = _interopRequireDefault(_accessibleTarget);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  } else {\n    var newObj = {};\n\n    if (obj != null) {\n      for (var key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];\n      }\n    }\n\n    newObj.default = obj;\n    return newObj;\n  }\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n} // add some extra variables to the container..\n\n\ncore.utils.mixins.delayMixin(core.DisplayObject.prototype, _accessibleTarget2.default);\nvar KEY_CODE_TAB = 9;\nvar DIV_TOUCH_SIZE = 100;\nvar DIV_TOUCH_POS_X = 0;\nvar DIV_TOUCH_POS_Y = 0;\nvar DIV_TOUCH_ZINDEX = 2;\nvar DIV_HOOK_SIZE = 1;\nvar DIV_HOOK_POS_X = -1000;\nvar DIV_HOOK_POS_Y = -1000;\nvar DIV_HOOK_ZINDEX = 2;\n/**\n * The Accessibility manager recreates the ability to tab and have content read by screen\n * readers. This is very important as it can possibly help people with disabilities access pixi\n * content.\n *\n * Much like interaction any DisplayObject can be made accessible. This manager will map the\n * events as if the mouse was being used, minimizing the effort required to implement.\n *\n * An instance of this class is automatically created by default, and can be found at renderer.plugins.accessibility\n *\n * @class\n * @memberof PIXI.accessibility\n */\n\nvar AccessibilityManager = function () {\n  /**\n   * @param {PIXI.CanvasRenderer|PIXI.WebGLRenderer} renderer - A reference to the current renderer\n   */\n  function AccessibilityManager(renderer) {\n    _classCallCheck(this, AccessibilityManager);\n\n    if ((_ismobilejs2.default.tablet || _ismobilejs2.default.phone) && !navigator.isCocoonJS) {\n      this.createTouchHook();\n    } // first we create a div that will sit over the PixiJS element. This is where the div overlays will go.\n\n\n    var div = document.createElement('div');\n    div.style.width = DIV_TOUCH_SIZE + 'px';\n    div.style.height = DIV_TOUCH_SIZE + 'px';\n    div.style.position = 'absolute';\n    div.style.top = DIV_TOUCH_POS_X + 'px';\n    div.style.left = DIV_TOUCH_POS_Y + 'px';\n    div.style.zIndex = DIV_TOUCH_ZINDEX;\n    /**\n     * This is the dom element that will sit over the PixiJS element. This is where the div overlays will go.\n     *\n     * @type {HTMLElement}\n     * @private\n     */\n\n    this.div = div;\n    /**\n     * A simple pool for storing divs.\n     *\n     * @type {*}\n     * @private\n     */\n\n    this.pool = [];\n    /**\n     * This is a tick used to check if an object is no longer being rendered.\n     *\n     * @type {Number}\n     * @private\n     */\n\n    this.renderId = 0;\n    /**\n     * Setting this to true will visually show the divs.\n     *\n     * @type {boolean}\n     */\n\n    this.debug = false;\n    /**\n     * The renderer this accessibility manager works for.\n     *\n     * @member {PIXI.SystemRenderer}\n     */\n\n    this.renderer = renderer;\n    /**\n     * The array of currently active accessible items.\n     *\n     * @member {Array<*>}\n     * @private\n     */\n\n    this.children = [];\n    /**\n     * pre-bind the functions\n     *\n     * @private\n     */\n\n    this._onKeyDown = this._onKeyDown.bind(this);\n    this._onMouseMove = this._onMouseMove.bind(this);\n    /**\n     * stores the state of the manager. If there are no accessible objects or the mouse is moving, this will be false.\n     *\n     * @member {Array<*>}\n     * @private\n     */\n\n    this.isActive = false;\n    this.isMobileAccessabillity = false; // let listen for tab.. once pressed we can fire up and show the accessibility layer\n\n    window.addEventListener('keydown', this._onKeyDown, false);\n  }\n  /**\n   * Creates the touch hooks.\n   *\n   */\n\n\n  AccessibilityManager.prototype.createTouchHook = function createTouchHook() {\n    var _this = this;\n\n    var hookDiv = document.createElement('button');\n    hookDiv.style.width = DIV_HOOK_SIZE + 'px';\n    hookDiv.style.height = DIV_HOOK_SIZE + 'px';\n    hookDiv.style.position = 'absolute';\n    hookDiv.style.top = DIV_HOOK_POS_X + 'px';\n    hookDiv.style.left = DIV_HOOK_POS_Y + 'px';\n    hookDiv.style.zIndex = DIV_HOOK_ZINDEX;\n    hookDiv.style.backgroundColor = '#FF0000';\n    hookDiv.title = 'HOOK DIV';\n    hookDiv.addEventListener('focus', function () {\n      _this.isMobileAccessabillity = true;\n\n      _this.activate();\n\n      document.body.removeChild(hookDiv);\n    });\n    document.body.appendChild(hookDiv);\n  };\n  /**\n   * Activating will cause the Accessibility layer to be shown. This is called when a user\n   * preses the tab key.\n   *\n   * @private\n   */\n\n\n  AccessibilityManager.prototype.activate = function activate() {\n    if (this.isActive) {\n      return;\n    }\n\n    this.isActive = true;\n    window.document.addEventListener('mousemove', this._onMouseMove, true);\n    window.removeEventListener('keydown', this._onKeyDown, false);\n    this.renderer.on('postrender', this.update, this);\n\n    if (this.renderer.view.parentNode) {\n      this.renderer.view.parentNode.appendChild(this.div);\n    }\n  };\n  /**\n   * Deactivating will cause the Accessibility layer to be hidden. This is called when a user moves\n   * the mouse.\n   *\n   * @private\n   */\n\n\n  AccessibilityManager.prototype.deactivate = function deactivate() {\n    if (!this.isActive || this.isMobileAccessabillity) {\n      return;\n    }\n\n    this.isActive = false;\n    window.document.removeEventListener('mousemove', this._onMouseMove, true);\n    window.addEventListener('keydown', this._onKeyDown, false);\n    this.renderer.off('postrender', this.update);\n\n    if (this.div.parentNode) {\n      this.div.parentNode.removeChild(this.div);\n    }\n  };\n  /**\n   * This recursive function will run through the scene graph and add any new accessible objects to the DOM layer.\n   *\n   * @private\n   * @param {PIXI.Container} displayObject - The DisplayObject to check.\n   */\n\n\n  AccessibilityManager.prototype.updateAccessibleObjects = function updateAccessibleObjects(displayObject) {\n    if (!displayObject.visible) {\n      return;\n    }\n\n    if (displayObject.accessible && displayObject.interactive) {\n      if (!displayObject._accessibleActive) {\n        this.addChild(displayObject);\n      }\n\n      displayObject.renderId = this.renderId;\n    }\n\n    var children = displayObject.children;\n\n    for (var i = 0; i < children.length; i++) {\n      this.updateAccessibleObjects(children[i]);\n    }\n  };\n  /**\n   * Before each render this function will ensure that all divs are mapped correctly to their DisplayObjects.\n   *\n   * @private\n   */\n\n\n  AccessibilityManager.prototype.update = function update() {\n    if (!this.renderer.renderingToScreen) {\n      return;\n    } // update children...\n\n\n    this.updateAccessibleObjects(this.renderer._lastObjectRendered);\n    var rect = this.renderer.view.getBoundingClientRect();\n    var sx = rect.width / this.renderer.width;\n    var sy = rect.height / this.renderer.height;\n    var div = this.div;\n    div.style.left = rect.left + 'px';\n    div.style.top = rect.top + 'px';\n    div.style.width = this.renderer.width + 'px';\n    div.style.height = this.renderer.height + 'px';\n\n    for (var i = 0; i < this.children.length; i++) {\n      var child = this.children[i];\n\n      if (child.renderId !== this.renderId) {\n        child._accessibleActive = false;\n        core.utils.removeItems(this.children, i, 1);\n        this.div.removeChild(child._accessibleDiv);\n        this.pool.push(child._accessibleDiv);\n        child._accessibleDiv = null;\n        i--;\n\n        if (this.children.length === 0) {\n          this.deactivate();\n        }\n      } else {\n        // map div to display..\n        div = child._accessibleDiv;\n        var hitArea = child.hitArea;\n        var wt = child.worldTransform;\n\n        if (child.hitArea) {\n          div.style.left = (wt.tx + hitArea.x * wt.a) * sx + 'px';\n          div.style.top = (wt.ty + hitArea.y * wt.d) * sy + 'px';\n          div.style.width = hitArea.width * wt.a * sx + 'px';\n          div.style.height = hitArea.height * wt.d * sy + 'px';\n        } else {\n          hitArea = child.getBounds();\n          this.capHitArea(hitArea);\n          div.style.left = hitArea.x * sx + 'px';\n          div.style.top = hitArea.y * sy + 'px';\n          div.style.width = hitArea.width * sx + 'px';\n          div.style.height = hitArea.height * sy + 'px'; // update button titles and hints if they exist and they've changed\n\n          if (div.title !== child.accessibleTitle && child.accessibleTitle !== null) {\n            div.title = child.accessibleTitle;\n          }\n\n          if (div.getAttribute('aria-label') !== child.accessibleHint && child.accessibleHint !== null) {\n            div.setAttribute('aria-label', child.accessibleHint);\n          }\n        }\n      }\n    } // increment the render id..\n\n\n    this.renderId++;\n  };\n  /**\n   * TODO: docs.\n   *\n   * @param {Rectangle} hitArea - TODO docs\n   */\n\n\n  AccessibilityManager.prototype.capHitArea = function capHitArea(hitArea) {\n    if (hitArea.x < 0) {\n      hitArea.width += hitArea.x;\n      hitArea.x = 0;\n    }\n\n    if (hitArea.y < 0) {\n      hitArea.height += hitArea.y;\n      hitArea.y = 0;\n    }\n\n    if (hitArea.x + hitArea.width > this.renderer.width) {\n      hitArea.width = this.renderer.width - hitArea.x;\n    }\n\n    if (hitArea.y + hitArea.height > this.renderer.height) {\n      hitArea.height = this.renderer.height - hitArea.y;\n    }\n  };\n  /**\n   * Adds a DisplayObject to the accessibility manager\n   *\n   * @private\n   * @param {DisplayObject} displayObject - The child to make accessible.\n   */\n\n\n  AccessibilityManager.prototype.addChild = function addChild(displayObject) {\n    //    this.activate();\n    var div = this.pool.pop();\n\n    if (!div) {\n      div = document.createElement('button');\n      div.style.width = DIV_TOUCH_SIZE + 'px';\n      div.style.height = DIV_TOUCH_SIZE + 'px';\n      div.style.backgroundColor = this.debug ? 'rgba(255,0,0,0.5)' : 'transparent';\n      div.style.position = 'absolute';\n      div.style.zIndex = DIV_TOUCH_ZINDEX;\n      div.style.borderStyle = 'none'; // ARIA attributes ensure that button title and hint updates are announced properly\n\n      if (navigator.userAgent.toLowerCase().indexOf('chrome') > -1) {\n        // Chrome doesn't need aria-live to work as intended; in fact it just gets more confused.\n        div.setAttribute('aria-live', 'off');\n      } else {\n        div.setAttribute('aria-live', 'polite');\n      }\n\n      if (navigator.userAgent.match(/rv:.*Gecko\\//)) {\n        // FireFox needs this to announce only the new button name\n        div.setAttribute('aria-relevant', 'additions');\n      } else {\n        // required by IE, other browsers don't much care\n        div.setAttribute('aria-relevant', 'text');\n      }\n\n      div.addEventListener('click', this._onClick.bind(this));\n      div.addEventListener('focus', this._onFocus.bind(this));\n      div.addEventListener('focusout', this._onFocusOut.bind(this));\n    }\n\n    if (displayObject.accessibleTitle && displayObject.accessibleTitle !== null) {\n      div.title = displayObject.accessibleTitle;\n    } else if (!displayObject.accessibleHint || displayObject.accessibleHint === null) {\n      div.title = 'displayObject ' + displayObject.tabIndex;\n    }\n\n    if (displayObject.accessibleHint && displayObject.accessibleHint !== null) {\n      div.setAttribute('aria-label', displayObject.accessibleHint);\n    } //\n\n\n    displayObject._accessibleActive = true;\n    displayObject._accessibleDiv = div;\n    div.displayObject = displayObject;\n    this.children.push(displayObject);\n    this.div.appendChild(displayObject._accessibleDiv);\n    displayObject._accessibleDiv.tabIndex = displayObject.tabIndex;\n  };\n  /**\n   * Maps the div button press to pixi's InteractionManager (click)\n   *\n   * @private\n   * @param {MouseEvent} e - The click event.\n   */\n\n\n  AccessibilityManager.prototype._onClick = function _onClick(e) {\n    var interactionManager = this.renderer.plugins.interaction;\n    interactionManager.dispatchEvent(e.target.displayObject, 'click', interactionManager.eventData);\n  };\n  /**\n   * Maps the div focus events to pixi's InteractionManager (mouseover)\n   *\n   * @private\n   * @param {FocusEvent} e - The focus event.\n   */\n\n\n  AccessibilityManager.prototype._onFocus = function _onFocus(e) {\n    if (!e.target.getAttribute('aria-live', 'off')) {\n      e.target.setAttribute('aria-live', 'assertive');\n    }\n\n    var interactionManager = this.renderer.plugins.interaction;\n    interactionManager.dispatchEvent(e.target.displayObject, 'mouseover', interactionManager.eventData);\n  };\n  /**\n   * Maps the div focus events to pixi's InteractionManager (mouseout)\n   *\n   * @private\n   * @param {FocusEvent} e - The focusout event.\n   */\n\n\n  AccessibilityManager.prototype._onFocusOut = function _onFocusOut(e) {\n    if (!e.target.getAttribute('aria-live', 'off')) {\n      e.target.setAttribute('aria-live', 'polite');\n    }\n\n    var interactionManager = this.renderer.plugins.interaction;\n    interactionManager.dispatchEvent(e.target.displayObject, 'mouseout', interactionManager.eventData);\n  };\n  /**\n   * Is called when a key is pressed\n   *\n   * @private\n   * @param {KeyboardEvent} e - The keydown event.\n   */\n\n\n  AccessibilityManager.prototype._onKeyDown = function _onKeyDown(e) {\n    if (e.keyCode !== KEY_CODE_TAB) {\n      return;\n    }\n\n    this.activate();\n  };\n  /**\n   * Is called when the mouse moves across the renderer element\n   *\n   * @private\n   * @param {MouseEvent} e - The mouse event.\n   */\n\n\n  AccessibilityManager.prototype._onMouseMove = function _onMouseMove(e) {\n    if (e.movementX === 0 && e.movementY === 0) {\n      return;\n    }\n\n    this.deactivate();\n  };\n  /**\n   * Destroys the accessibility manager\n   *\n   */\n\n\n  AccessibilityManager.prototype.destroy = function destroy() {\n    this.div = null;\n\n    for (var i = 0; i < this.children.length; i++) {\n      this.children[i].div = null;\n    }\n\n    window.document.removeEventListener('mousemove', this._onMouseMove, true);\n    window.removeEventListener('keydown', this._onKeyDown);\n    this.pool = null;\n    this.children = null;\n    this.renderer = null;\n  };\n\n  return AccessibilityManager;\n}();\n\nexports.default = AccessibilityManager;\ncore.WebGLRenderer.registerPlugin('accessibility', AccessibilityManager);\ncore.CanvasRenderer.registerPlugin('accessibility', AccessibilityManager);","map":null,"metadata":{},"sourceType":"script"}